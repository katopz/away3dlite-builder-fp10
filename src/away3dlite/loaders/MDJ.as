package away3dlite.loaders{	import away3dlite.animators.MovieMesh;	import away3dlite.animators.MovieMeshContainer3D;	import away3dlite.arcane;	import away3dlite.core.IDestroyable;	import away3dlite.events.Loader3DEvent;	import away3dlite.materials.BitmapFileMaterial;	import com.adobe.serialization.json.JSON;	use namespace arcane;	/**	 * File loader for the MDJ file format. It's MD2, Texture,... in JSON format.	 *	 * @example	 * {	 * 	"meshes" : ["model.md2"],	 * 	"textures" : ["model.png"]	 * }	 *	 * @author katopz@sleepydesign.com	 */	public class MDJ extends AbstractParser implements IDestroyable	{		private var _loadedMD2:int = 0;		private var _loader3Ds:Array;				public var meshPath:String = "";		public var texturePath:String = "";		/** @private */		arcane override function prepareData(data:*):void		{			var i:int = 0;			var _models:Object = JSON.decode(data) as Object;			var _meshList:Array = _models.meshes;			var _materialList:Array = _models.textures;			_loadedMD2 = 0;			_loader3Ds = [];			var _meshList_length:int = _meshList.length;			for (i = 0; i < _meshList_length; i++)			{				var _md2:MD2 = new MD2();				_md2.scaling = scaling;				_md2.name = String(_meshList[i]).split(".md2")[0];				_md2.name = _md2.name.slice(_md2.name.lastIndexOf("/") + 1);				_md2.name = _md2.name.split("_")[0];				_md2.material = new BitmapFileMaterial(texturePath + _materialList[i]);				var _loader3D:Loader3D = new Loader3D();				_container.addChild(_loader3D);				_loader3D.name = _md2.name;				_loader3D.addEventListener(Loader3DEvent.LOAD_SUCCESS, onSuccess);				_loader3D.loadGeometry(meshPath + _meshList[i], _md2);				_loader3Ds.push(_loader3D);			}		}		private function onSuccess(event:Loader3DEvent):void		{			var model:MovieMesh = event.loader.handle as MovieMesh;			model.bothsides = bothsides;			if (++_loadedMD2 == _loader3Ds.length)			{				if (autoPlay)					MovieMeshContainer3D(_container).play();				super.notifySuccess();				// gc				_loader3Ds = null;			}		}		/** @private */		arcane override function notifySuccess():void		{			// void JSON notifySuccess, wait for mesh success		}		public var autoPlay:Boolean = true;		public var bothsides:Boolean = false;		/**		 * A scaling factor for all geometry in the model. Defaults to 1.		 */		public var scaling:Number = 1;		/**		 * Controls the automatic centering of geometry data in the model, improving culling and the accuracy of bounding dimension values.		 */		public var centerMeshes:Boolean;		/**		 * Creates a new <code>MDJ</code> object.		 */		public function MDJ()		{			_container = new MovieMeshContainer3D();			binary = false;		}	}}